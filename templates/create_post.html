{% extends "base.html" %}

{% block title %}Create Post - LinkedIn Scheduler{% endblock %}

{% block content %}
<div class="buffer-create-post">
    <div class="buffer-container">
        <!-- Header -->
        <div class="buffer-header">
            <h1 class="buffer-title">Create Post</h1>
            <div class="buffer-actions">
                <button type="button" class="buffer-btn buffer-btn-secondary" onclick="addTags()">
                    <i class="fas fa-tag"></i>
                    Add Tags
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
        </div>

        <div class="buffer-main">
            <!-- Left Panel - Create Post -->
            <div class="buffer-left-panel">
                <form id="create-post-form" enctype="multipart/form-data">
                    <!-- Channel Selection -->
                    <div class="buffer-channels">
                        <div class="channel-item active" data-channel="linkedin">
                            <div class="channel-avatar">
                                <img src="{{ current_user.profile_picture or '/static/images/default-avatar.png' }}" alt="Profile" class="channel-img">
                                <div class="channel-badge">
                                    <i class="fab fa-linkedin-in"></i>
                                </div>
                            </div>
                        </div>
                        <div class="channel-item disabled" data-channel="twitter">
                            <div class="channel-avatar">
                                <img src="{{ current_user.profile_picture or '/static/images/default-avatar.png' }}" alt="Profile" class="channel-img">
                                <div class="channel-badge">
                                    <i class="fab fa-twitter"></i>
                                </div>
                            </div>
                        </div>
                        <div class="channel-item disabled" data-channel="facebook">
                            <div class="channel-avatar">
                                <img src="{{ current_user.profile_picture or '/static/images/default-avatar.png' }}" alt="Profile" class="channel-img">
                                <div class="channel-badge">
                                    <i class="fab fa-facebook-f"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="buffer-content-area">
                        <div class="buffer-platform-icon">
                            <i class="fab fa-linkedin-in"></i>
                        </div>
                        
                        <div class="buffer-compose">
                            <textarea 
                                id="post-content" 
                                name="content" 
                                class="buffer-textarea" 
                                placeholder="What would you like to share?"
                                rows="8"
                                maxlength="3000"
                                required
                            ></textarea>
                            
                            <!-- Media Upload Area -->
                            <div class="buffer-media-upload" id="media-upload-area">
                                <input type="file" id="post-image" name="image" accept="image/*" class="buffer-file-input">
                                <div class="buffer-upload-placeholder">
                                    <div class="upload-icon">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    <div class="upload-text">
                                        <span>Drag & drop</span>
                                        <br>
                                        <span>or <a href="#" class="upload-link">select a file</a></span>
                                    </div>
                                </div>
                                <div id="image-preview" class="buffer-image-preview" style="display: none;">
                                    <img id="preview-img" src="" alt="Preview">
                                    <button type="button" class="buffer-remove-image" onclick="removeImage()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div class="buffer-toolbar">
                        <div class="buffer-toolbar-left">
                            <button type="button" class="buffer-tool-btn" onclick="document.getElementById('post-image').click()">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button type="button" class="buffer-tool-btn">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                            <button type="button" class="buffer-tool-btn">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button type="button" class="buffer-tool-btn">
                                <i class="fas fa-hashtag"></i>
                            </button>
                            <button type="button" class="buffer-tool-btn">
                                <i class="fas fa-magic"></i>
                            </button>
                            <button type="button" class="buffer-tool-btn buffer-ai-btn">
                                <i class="fas fa-robot"></i>
                                <span>AI Assistant</span>
                            </button>
                        </div>
                        <div class="buffer-toolbar-right">
                            <span class="buffer-char-count">
                                <span id="char-count">3000</span>
                            </span>
                        </div>
                    </div>

                    <!-- First Comment -->
                    <div class="buffer-first-comment">
                        <div class="first-comment-label">First Comment</div>
                        <textarea 
                            class="buffer-comment-textarea" 
                            placeholder="Your comment"
                        ></textarea>
                    </div>

                    <!-- Scheduling Section -->
                    <div class="buffer-scheduling">
                        <div class="buffer-schedule-header">
                            <span class="schedule-label">When to Post</span>
                            <div class="buffer-schedule-dropdown">
                                <button type="button" class="buffer-dropdown-btn" id="schedule-dropdown">
                                    <i class="fas fa-clock"></i>
                                    <span id="schedule-text">Next Available</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="buffer-schedule-options" id="schedule-options" style="display: none;">
                            <div class="schedule-option" data-type="now">
                                <i class="fas fa-paper-plane"></i>
                                <span>Share now</span>
                            </div>
                            <div class="schedule-option" data-type="next">
                                <i class="fas fa-clock"></i>
                                <span>Next Available</span>
                            </div>
                            <div class="schedule-option" data-type="custom">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Schedule Post</span>
                            </div>
                        </div>
                        
                        <div id="custom-schedule" class="buffer-custom-schedule" style="display: none;">
                            <input type="datetime-local" id="scheduled-time" name="scheduled_time" class="buffer-datetime-input">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="buffer-actions-bottom">
                        <button type="button" class="buffer-btn buffer-btn-draft" onclick="saveDraft()">
                            Save as Draft
                        </button>
                        <button type="submit" class="buffer-btn buffer-btn-primary" id="submit-btn">
                            <span id="submit-text">Schedule Post</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right Panel - Preview -->
            <div class="buffer-right-panel">
                <div class="buffer-preview-header">
                    <h3>LinkedIn Preview</h3>
                    <i class="fas fa-info-circle" title="Preview of how your post will appear"></i>
                </div>
                
                <div class="buffer-preview-content">
                    <div id="linkedin-preview" class="linkedin-post-preview">
                        <div class="preview-placeholder">
                            <i class="fab fa-linkedin-in"></i>
                            <p>See your post's preview here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Buffer-style functionality
const postContent = document.getElementById('post-content');
const charCount = document.getElementById('char-count');
const fileInput = document.getElementById('post-image');
const mediaUploadArea = document.getElementById('media-upload-area');
const imagePreview = document.getElementById('image-preview');
const previewImg = document.getElementById('preview-img');
const scheduleDropdown = document.getElementById('schedule-dropdown');
const scheduleOptions = document.getElementById('schedule-options');
const customSchedule = document.getElementById('custom-schedule');
const submitBtn = document.getElementById('submit-btn');
const submitText = document.getElementById('submit-text');
const scheduleText = document.getElementById('schedule-text');

let currentScheduleType = 'next';

// Character counter and preview update
postContent.addEventListener('input', function() {
    const length = this.value.length;
    const remaining = 3000 - length;
    charCount.textContent = remaining;
    
    if (remaining < 100) {
        charCount.style.color = '#ef4444';
    } else if (remaining < 300) {
        charCount.style.color = '#f59e0b';
    } else {
        charCount.style.color = '#6b7280';
    }
    
    updateLinkedInPreview();
});

// LinkedIn Preview Update
function updateLinkedInPreview() {
    const content = postContent.value.trim();
    const previewContainer = document.getElementById('linkedin-preview');
    
    if (!content && !imagePreview.style.display === 'block') {
        previewContainer.innerHTML = `
            <div class="preview-placeholder">
                <i class="fab fa-linkedin-in"></i>
                <p>See your post's preview here</p>
            </div>
        `;
        return;
    }
    
    const hasImage = imagePreview.style.display === 'block';
    const imageSrc = hasImage ? previewImg.src : '';
    
    previewContainer.innerHTML = `
        <div class="linkedin-preview-post">
            <div class="linkedin-preview-header">
                <div class="linkedin-preview-avatar">
                    <img src="{{ current_user.profile_picture or '/static/images/default-avatar.png' }}" alt="Profile">
                </div>
                <div class="linkedin-preview-info">
                    <div class="linkedin-preview-name">{{ current_user.name }}</div>
                    <div class="linkedin-preview-meta">Just now • <i class="fas fa-globe-americas"></i></div>
                </div>
            </div>
            <div class="linkedin-preview-content">
                ${content ? `<div class="linkedin-preview-text">${content}</div>` : ''}
                ${hasImage ? `<div class="linkedin-preview-image"><img src="${imageSrc}" alt="Post image"></div>` : ''}
            </div>
            <div class="linkedin-preview-actions">
                <div class="linkedin-preview-action">
                    <i class="far fa-thumbs-up"></i>
                    <span>Like</span>
                </div>
                <div class="linkedin-preview-action">
                    <i class="far fa-comment"></i>
                    <span>Comment</span>
                </div>
                <div class="linkedin-preview-action">
                    <i class="fas fa-share"></i>
                    <span>Share</span>
                </div>
            </div>
        </div>
    `;
}

// File upload handling
mediaUploadArea.addEventListener('click', (e) => {
    if (e.target.classList.contains('upload-link') || e.target.closest('.upload-link')) {
        e.preventDefault();
        fileInput.click();
    }
});

// Drag and drop functionality
mediaUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    mediaUploadArea.classList.add('dragover');
});

mediaUploadArea.addEventListener('dragleave', () => {
    mediaUploadArea.classList.remove('dragover');
});

mediaUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    mediaUploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        handleFileSelect(this.files[0]);
    }
});

function handleFileSelect(file) {
    if (!file.type.startsWith('image/')) {
        showFlashMessage('Please select an image file', 'error');
        return;
    }
    
    if (file.size > 16 * 1024 * 1024) {
        showFlashMessage('File size must be less than 16MB', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImg.src = e.target.result;
        imagePreview.style.display = 'block';
        mediaUploadArea.querySelector('.buffer-upload-placeholder').style.display = 'none';
        updateLinkedInPreview();
    };
    reader.readAsDataURL(file);
}

function removeImage() {
    fileInput.value = '';
    imagePreview.style.display = 'none';
    mediaUploadArea.querySelector('.buffer-upload-placeholder').style.display = 'block';
    updateLinkedInPreview();
}

// Schedule dropdown functionality
scheduleDropdown.addEventListener('click', function() {
    const isVisible = scheduleOptions.style.display === 'block';
    scheduleOptions.style.display = isVisible ? 'none' : 'block';
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!scheduleDropdown.contains(e.target) && !scheduleOptions.contains(e.target)) {
        scheduleOptions.style.display = 'none';
    }
});

// Schedule option selection
scheduleOptions.addEventListener('click', function(e) {
    const option = e.target.closest('.schedule-option');
    if (!option) return;
    
    const type = option.dataset.type;
    currentScheduleType = type;
    
    switch(type) {
        case 'now':
            scheduleText.textContent = 'Share now';
            customSchedule.style.display = 'none';
            submitText.textContent = 'Share now';
            break;
        case 'next':
            scheduleText.textContent = 'Next Available';
            customSchedule.style.display = 'none';
            submitText.textContent = 'Schedule Post';
            break;
        case 'custom':
            scheduleText.textContent = 'Schedule Post';
            customSchedule.style.display = 'block';
            submitText.textContent = 'Schedule Post';
            // Set minimum date to current time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('scheduled-time').min = now.toISOString().slice(0, 16);
            break;
    }
    
    scheduleOptions.style.display = 'none';
});

// Helper functions
function addTags() {
    alert('Tags functionality coming soon!');
}

function saveDraft() {
    if (!postContent.value.trim()) {
        showFlashMessage('Please enter some content for your post', 'error');
        postContent.focus();
        return;
    }
    
    const formData = new FormData(document.getElementById('create-post-form'));
    formData.set('schedule_type', 'draft');
    
    submitForm(formData, 'draft');
}

// Form submission
document.getElementById('create-post-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!postContent.value.trim()) {
        showFlashMessage('Please enter some content for your post', 'error');
        postContent.focus();
        return;
    }
    
    const formData = new FormData(this);
    
    // Set schedule type based on current selection
    if (currentScheduleType === 'now') {
        formData.set('schedule_type', 'now');
    } else if (currentScheduleType === 'custom') {
        const scheduledTime = document.getElementById('scheduled-time').value;
        if (!scheduledTime) {
            showFlashMessage('Please select a date and time for scheduling', 'error');
            return;
        }
        
        const scheduledDate = new Date(scheduledTime);
        if (scheduledDate <= new Date()) {
            showFlashMessage('Scheduled time must be in the future', 'error');
            return;
        }
        
        formData.set('schedule_type', 'scheduled');
    } else {
        formData.set('schedule_type', 'scheduled'); // Next available
    }
    
    submitForm(formData, currentScheduleType);
});

function submitForm(formData, type) {
    showLoading();
    submitBtn.disabled = true;
    
    fetch('/api/posts', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        submitBtn.disabled = false;
        
        if (data.success) {
            let message = 'Post saved as draft!';
            if (type === 'now') message = 'Post shared successfully!';
            else if (type === 'next' || type === 'custom') message = 'Post scheduled successfully!';
            
            showFlashMessage(message, 'success');
            
            // Redirect to dashboard
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            showFlashMessage(data.error || 'Failed to create post', 'error');
        }
    })
    .catch(error => {
        hideLoading();
        submitBtn.disabled = false;
        showFlashMessage('An error occurred while creating the post', 'error');
        console.error('Error:', error);
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('scheduled-time').min = now.toISOString().slice(0, 16);
    
    // Initialize character count
    charCount.textContent = '3000';
    
    // Initialize preview
    updateLinkedInPreview();
});
</script>
{% endblock %}
